<!-- build time:Sun May 05 2019 18:42:23 GMT+0800 (CST) --><!DOCTYPE html><html lang="zh-Hans" class="loading"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>Unity Simple 2D Water Shader - 鸵鸟工作室</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><meta name="keywords" content="Fechin,"><meta name="description" content="鸵鸟工作室,效果项目地址在线演示笔记本来是要抄 帝国时代2HD 中的水面效果来的,后来折腾了好久. 发现搞不定😂, 弄出来的效果总是怪怪的. 没有原版的那种 高逼格的低调奢华.😑网上有搜了许多,不过每个效果,"><meta name="author" content="鸵鸟工作室"><link rel="alternative" href="atom.xml" title="鸵鸟工作室" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="/css/diaspora.css"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8691406134231910",enable_page_level_ads:!0})</script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script></head></html><body class="loading"><span id="config-title" style="display:none">鸵鸟工作室</span><div id="loader"></div><div id="single"><div id="top" style="display:block"><div class="bar" style="width:0"></div><a class="icon-home image-icon" href="javascript:;" data-url="http://鸵鸟工作室.fun"></a><div title="播放/暂停" class="icon-play"></div><h3 class="subtitle">Unity Simple 2D Water Shader</h3><div class="social"><div><div class="share"><a title="获取二维码" class="icon-scan" href="javascript:;"></a></div><div id="qr"></div></div></div><div class="scrollbar"></div></div><div class="section"><div class="article"><div class="main"><h1 class="title">Unity Simple 2D Water Shader</h1><div class="stuff"><span>十一月 25, 2018</span><ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Shader/">Shader</a></li></ul></div><div class="content markdown"><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://tunied.github.io/Gifs/Simple2DWater_Preview.gif" alt=""></p><p><a href="https://github.com/Tunied/Simple2DWater" target="_blank" rel="noopener">项目地址</a></p><p><a href="https://tunied.github.io/Simple2DWater/" target="_blank" rel="noopener">在线演示</a></p><h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><p>本来是要抄 帝国时代2HD 中的水面效果来的,后来折腾了好久. 发现搞不定😂, 弄出来的效果总是怪怪的. 没有原版的那种 高逼格的低调奢华.😑</p><p>网上有搜了许多,不过每个效果都弄的酷炫无比,没有个3A游戏的底子都不好意思用. 后来搜到了 <a href="http://gad.qq.com/article/detail/25973" target="_blank" rel="noopener">则卷大明 的 Unity3D-移动平台简单水效果的实现</a> 感觉思路很好. 就照着改了改. 以下是这段做水Shader中学到的心得.</p><h3 id="制作思路"><a href="#制作思路" class="headerlink" title="制作思路"></a>制作思路</h3><p>首先是 则卷大明 这版中的 直接用单张纹理来模拟 水面波动+光照. 这个思路很好. 比起扰动Normal的方法要省事许多. 不过他这版有几个地方我觉得不太适合我的项目.所以做了少许更改</p><ul><li>将光斑改为屏幕坐标系下.(同 AoE2 HD)</li><li>分离水面纹理和光照纹理 : 这样方便调整效果,但是会增加一次Simpling.不过我底图纹理还加入了扰动包括后面底图还会做多张纹理的Blend.所以拆分并没有增加整体的性能损耗.</li><li>底图加入扰动 : 同 AoE2 , 让水有一种很弱的流动感</li><li>去除fresnel和高光 : 因为视角是斜45锁定视角,所以相关的效果都可以直接在光照纹理中模拟出来.</li></ul><h3 id="学到的东西"><a href="#学到的东西" class="headerlink" title="学到的东西"></a>学到的东西</h3><h4 id="快速计算World-Normal"><a href="#快速计算World-Normal" class="headerlink" title="快速计算World Normal"></a>快速计算World Normal</h4><p>原先是按 冯乐乐书中的构建矩阵的方式保留Normal变换矩阵,然后在frag中把Simpling到的切空间结果转一下 (P153 7.2 凹凸映射). 后来发现自己傻了.</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float3 bump = UnpackNormal(<span class="name">tex2D</span>(<span class="name">_BumpMap</span>,i.uv.xy))<span class="comment">; //取得Tangent空间下的Normal扰动值</span></span><br><span class="line">float3 worldBump = float3(<span class="name">bump</span>.xzy)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>直接更换yz即可得到worldNormal的扰动值,又因为初始Normal肯定都是<code>Vector3.Up</code>, 所以连先使用<code>UnityObjectToWorldNormal</code>求得原始Normal</p><p>然后再线性插值传到frag中 <code>*= worldBump</code> 都可以省略了.</p><p>直接使用worldBump作为最终的Normal就行了.</p><p>当然后来我发现 其实我连Normal都不需要…😂</p><h4 id="使用viewVector-y判断离相机远近"><a href="#使用viewVector-y判断离相机远近" class="headerlink" title="使用viewVector.y判断离相机远近"></a>使用viewVector.y判断离相机远近</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">v2f <span class="title">vert</span> (<span class="params">appdata v</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	v2f o;</span><br><span class="line"></span><br><span class="line">	o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">	float3 worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">	o.viewVector = (_WorldSpaceCameraPos.xyz - worldPos);</span><br><span class="line">	<span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> <span class="keyword">value</span> = normalize(i.viewVector).y * _Power;</span><br><span class="line">	<span class="keyword">return</span> float4(<span class="keyword">value</span>,<span class="keyword">value</span>,<span class="keyword">value</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/media/15431414049997.jpg" alt=""></p><p>接近水平情况</p><p><img src="/media/15431426719096.jpg" alt=""></p><p><img src="/media/15431426841176.jpg" alt=""></p><p>接近垂直情况</p><p><img src="/media/15431427837484.jpg" alt=""></p><p><img src="/media/15431427694533.jpg" alt=""></p><h4 id="使用NormalMap来制作扰动"><a href="#使用NormalMap来制作扰动" class="headerlink" title="使用NormalMap来制作扰动"></a>使用NormalMap来制作扰动</h4><p>Perlin Noise 产生的随机数区间是[0~1],经过转换后可变变为[-1~1]的区间. 但是对于单通道的Perlin Noise xy(rg)通道取得的值都一样. 也就是要么均为正 要么均为负.</p><p>所以如果直接使用Perlin Noise图来进行扰动的话会出现明显的图片偏移情况.</p><p><a href="http://kitfox.com/projects/perlinNoiseMaker/" target="_blank" rel="noopener">Perlin Noise Maker</a>里面可以生成<code>Color</code>的纹理图. 我之前使用的就是这个方案. 也就是rgba通道对应四张纹理图.</p><p>这样Simpling时候xy的值不会同时为正或者同时为负. 不过可能是因为每个通道的Noise不同 最终效果并不好.</p><p>但是直接使用NormalMap就不会出现这种困扰.NormalMap在切空间内Z值朝上xy是在整个[-1,1]的空间内取值.</p><p><img src="/media/15123441065379.png" alt="15123441065379"></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">half4 PrintBump(float2 _bump)</span><br><span class="line">&#123;</span><br><span class="line">	if(_bump.x &gt; <span class="number">0</span> &amp;&amp; _bump.y &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		return float4(<span class="number">0.0000</span>, <span class="number">0.5020</span>, <span class="number">0.2510</span>,<span class="number">1</span>); <span class="comment">//墨绿=&gt; 右上</span></span><br><span class="line">	&#125;</span><br><span class="line">	else if(_bump.x &lt; <span class="number">0</span> &amp;&amp; _bump.y &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		return float4(<span class="number">1.0000</span>, <span class="number">1.0000</span>, <span class="number">0.0000</span>,<span class="number">1</span>);<span class="comment">//黄色 =&gt; 左下</span></span><br><span class="line">	&#125;</span><br><span class="line">	else if(_bump.x &gt; <span class="number">0</span> &amp;&amp; _bump.y &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		return float4(<span class="number">0.6000</span>, <span class="number">0.4000</span>, <span class="number">0.2000</span>,<span class="number">1</span>); <span class="comment">//棕色 =&gt; 右下</span></span><br><span class="line">	&#125;</span><br><span class="line">	else if(_bump.x &lt; <span class="number">0</span> &amp;&amp; _bump.y &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		return float4(<span class="number">0.0000</span>, <span class="number">0.0000</span>, <span class="number">1.0000</span>,<span class="number">1</span>); <span class="comment">//蓝色 =&gt; 左上</span></span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		return float4(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接输出NoiseMap:</p><p><img src="/media/15431447247834.jpg" alt=""></p><p>输出NoiseMap转换后的NormalMap</p><p><img src="/media/15431446637660.jpg" alt=""></p><h5 id="单方向-amp-双方向-Loop-Noise"><a href="#单方向-amp-双方向-Loop-Noise" class="headerlink" title="单方向&amp;双方向 Loop Noise"></a>单方向&amp;双方向 Loop Noise</h5><p>单方向Loop Noise有明显的朝某方向移动的感觉,双方向Loop Noise则是扰动的效果</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float3 b1 = UnpackNormal(<span class="name">tex2D</span>(<span class="name">_BumpTex</span>,i.uv.zw + _Time.yy * _BumpDir.xy * _BumpSpeed1))<span class="comment">;</span></span><br><span class="line">float3 b2 = UnpackNormal(<span class="name">tex2D</span>(<span class="name">_BumpTex</span>,i.uv.zw + _Time.yy * _BumpDir.zw * _BumpSpeed2))<span class="comment">; </span></span><br><span class="line"></span><br><span class="line">fixed4 oneDir = tex2D(<span class="name">_SunTex</span>,i.uv2 + b1 * _BumpPower);</span><br><span class="line">fixed4 twoDir = tex2D(_SunTex,i.uv2 + (b1+b2) * _BumpPower)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><img src="/media/15431452236867.jpg" alt=""></p><p>对于单方向Loop 可以找到对应的Pa’点 使得其变化的值只和Pa点相差了△t个时间单位.</p><p>但是对于双方向的遍历Pb点,则找不出任何一个Pb’点 和其值一直相等只相差了△t个时间单位.</p><!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]--><audio id="audio" loop preload="auto" controls data-autoplay="false"><source type="audio/mpeg" src=""></audio><ul id="audio-list" style="display:none"><li title="0" data-url="http://link.hhtjim.com/163/5146554.mp3"></li><li title="1" data-url="http://link.hhtjim.com/qq/001faIUs4M2zna.mp3"></li></ul></div><div id="gitalk-container" class="comment link" data-ae="false" data-ci="" data-cs="" data-r="" data-o="" data-a="" data-d="false">查看评论</div></div></div></div></div></body><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script><script src="/js/plugin.js"></script><script src="/js/diaspora.js"></script><link rel="stylesheet" href="/photoswipe/photoswipe.css"><link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css"><script src="/photoswipe/photoswipe.min.js"></script><script src="/photoswipe/photoswipe-ui-default.min.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><!-- rebuild by neat -->